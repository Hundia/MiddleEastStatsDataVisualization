<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drawing Data</title>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- Select stuff extention for bootstrap -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/css/bootstrap-select.min.css">
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/i18n/defaults-*.min.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/bootstrap-select.min.js"></script>-->


    <script type="text/javascript" src="./js/timeline.js"></script>
    <link rel="stylesheet" href="/timelinejs-slider/dist/css/timeline.min.css" />

    <link href="./c3/c3.css" rel="stylesheet">

    <!-- Load d3.js and c3.js -->
    <script src="./c3/d3/d3.min.js"></script>
    <script src="./c3/c3.min.js"></script>

    <style>
            .bar{
                fill: steelblue;
            }

            .bar:hover{
                fill: brown;
            }

            .axis {
                font: 10px sans-serif;
            }

            .axis path,
            .axis line {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }
            .row {
                margin-bottom: 35px;
            }
    </style>

</head>


<body>


    <div class="container">
        <h1 align="center">The war of the middle east</h1>
        <h2 align="center">A song of stats and data</h2>

        <div class="row">

            <div class="timeline-container timeline-theme-1 row">
                <div class="timeline js-timeline">
                    <!--<div data-time="1947">-->
                        <!--November 1947 – July 1949 - Israeli war of independence-->
                    <!--</div>-->
                    <!--<div data-time="1956">-->
                        <!--October 1956 - Suez Crisis-->
                    <!--</div>-->
                    <div data-time="1967">
                        June 1967 - Six-Day War
                    </div>
                    <div data-time="1968">
                        1968–1970 - War of Attrition
                    </div>
                    <div data-time="1973">
                        October 1973 - Yom Kippur War
                    </div>
                    <div data-time="1982">
                        1982 - Lebanon War
                    </div>
                    <div data-time="1987">
                        1987–1993 - First Intifada
                    </div>
                    <div data-time="2000">
                        2000–2005 - Second Intifada
                    </div>
                    <div data-time="2006">
                        summer 2006 - Second Lebanon War
                    </div>
                    <div data-time="2008">
                        December 2008 – January 2009 - Gaza War
                    </div>
                    <div data-time="2012">
                        November 2012 - Operation Pillar of Defense
                    </div>
                    <div data-time="2014">
                        July–August 2014 - Operation Protective Edge
                    </div>
                </div>
            </div>
        </div>

        <div class="col-sm-12" id="graphs_container">

        </div>

    </div>




    <script>

//        function setArabIsraeliWar1948() {
//            var start = 1948;
//            var end = 1951;
//            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
//            onNewBarUpdateWithYears(start, end, selectedCountries)(start, end, selectedCountries);
//        }
//
//        function setSuezCrisis1956() {
//            var start = 1954;
//            var end = 1958;
//            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
//            onNewBarUpdateWithYears(start, end, selectedCountries)(start, end, selectedCountries);
//        }



        //  Map out the files
        var fieldToIndicatorsTxtMap = {};
        fieldToIndicatorsTxtMap['financial'] = "../metadata_indicators/financial.txt";
        fieldToIndicatorsTxtMap['military'] = "../metadata_indicators/military.txt";
        fieldToIndicatorsTxtMap['population'] = "../metadata_indicators/population.txt";
        fieldToIndicatorsTxtMap['science_education'] = "../metadata_indicators/science_education.txt";


        function setSixDaysWar1967() {
            var start = 1965;
            var end = 1969;
            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
            onNewBarUpdateWithYears(start, end, selectedCountries);
        }

        function setWarOfAttrition1968() {
            var start = 1967;
            var end = 1970;
            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
            onNewBarUpdateWithYears(start, end, selectedCountries);
        }

        function setWarOfYomKipur1973() {
            var start = 1971;
            var end = 1975;
            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
            onNewBarUpdateWithYears(start, end, selectedCountries);
        }

        function setLebanonWar1982() {
            var start = 1980;
            var end = 1984;
            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
            onNewBarUpdateWithYears(start, end, selectedCountries);
        }

        function setFirstIntefada1987() {
            var start = 1985;
            var end = 1989;
            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
            onNewBarUpdateWithYears(start, end, selectedCountries);
        }

        function setSecondIntefada2000() {
            var start = 1998;
            var end = 2002;
            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
            onNewBarUpdateWithYears(start, end, selectedCountries);
        }

        function setSecondLebanonWar2006() {
            var start = 2004;
            var end = 2007;
            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
            onNewBarUpdateWithYears(start, end, selectedCountries);
        }

        function setGazaWar2008() {
            var start = 2007;
            var end = 2010;
            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
            onNewBarUpdateWithYears(start, end, selectedCountries);
        }

        function setOperationPillarOfDefense2012() {
            var start = 2011;
            var end = 2013;
            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
            onNewBarUpdateWithYears(start, end, selectedCountries);
        }

        function setOperationProtectiveEdge2014() {
            var start = 2013;
            var end = 2015;
            var selectedCountries = ['ISR','JOR','EGY','LBN','PSE'];
            onNewBarUpdateWithYears(start, end, selectedCountries);
        }

        function setUpListeners() {


            $('.js-timeline').Timeline();

            //        $( "#1947" ).click(function() {
            //            setArabIsraeliWar1948();
            //            alert('test');
            //        });
            //        $( "#1956" ).click(function() {
            //            setSuezCrisis1956();
            //        });
            $("#1967").click(function () {
                setSixDaysWar1967();
            });
            $("#1968").click(function () {
                setWarOfAttrition1968();
            });

            $("#1973").click(function () {
                setWarOfYomKipur1973();
            });

            $("#1982").click(function () {
                setLebanonWar1982();
            });

            $("#1987").click(function () {
                setFirstIntefada1987();
            });

            $("#2000").click(function () {
                setSecondIntefada2000();
            });

            $("#2006").click(function () {
                setSecondLebanonWar2006();
            });

            $("#2008").click(function () {
                setGazaWar2008();
            });

            $("#2012").click(function () {
                setOperationPillarOfDefense2012();
            });

            $("#2014").click(function () {
                setOperationProtectiveEdge2014();
            });
        }




        function buildJsonFromData(json2parse) {
            d3.select("svg").remove();
//            var start = document.getElementById('yearStart');
//            var end = document.getElementById('yearEnd');
//            var country = document.getElementById('Country');
            console.log('Start Year: ' + start.options[start.selectedIndex].value);
            console.log('End Year: ' + end.options[end.selectedIndex].value);

            var yearStart = start.options[start.selectedIndex].value;
            var yearEnd = end.options[end.selectedIndex].value;
//            var cntryName = country.options[country.selectedIndex].value;


            var parsedJson = [];


            console.log('Selected Countries:');
            for (i = 0; i < country.length; i++) {
                if (country.options[i].selected) {
                    selectedCountries.push(country.options[i].value);
                    console.log(country.options[i].value);
                }
            }

            console.log('Selected length: ' + selectedCountries.length);
            for (i = 0; i < selectedCountries.length; i++) {
                cntryName = selectedCountries[i];
                xhr = new XMLHttpRequest();
                reqStr = "http://localhost:5000/getCountriesHiTechInfoLineCharted?country=" + cntryName + '&yearStart=' + yearStart + "&yearEnd=" + yearEnd;
                xhr.open("GET", reqStr, false);
                xhr.send();

                parsedJson = [];
                parsedJson.push(JSON.parse(xhr.response));

//            console.log(parsedJson);
                json2parse.push(parsedJson);
            }
        }

        function buildJsonFromDataWithoutOptions(json2parse, start, end, countries, indicator) {
            //d3.select("svg").remove();

            var yearStart = start;
            var yearEnd = end;
            var infoLabel = indicator;
            var parsedJson = [];
            var selectedCountries = [];

//            console.log('Selected Countries:');
            for (i = 0; i < countries.length; i++) {
                    selectedCountries.push(countries[i]);
//                    console.log('Countries in the conflict: ' + countries[i]);
            }

            for (i = 0; i < selectedCountries.length; i++) {
                cntryName = selectedCountries[i];
                xhr = new XMLHttpRequest();

                reqStr = "http://localhost:5000/getCountriesHiTechInfoLineCharted?country=" + cntryName + '&yearStart=' + yearStart + "&yearEnd=" + yearEnd + "&infoLabel=" + infoLabel;
//                console.log(reqStr);
                xhr.open("GET", reqStr, false);
                xhr.withCredentials = false;
                xhr.send();

                parsedJson = [];
                parsedJson.push(JSON.parse(xhr.response));

//                console.log(parsedJson);
                json2parse.push(parsedJson);
            }
        }

        function onLineUpdate() {
            var json2parse = [];

            buildJsonFromData(json2parse);

//            console.log(parsedJson);
//            json2parse.push(parsedJson);

            updateNew(json2parse, 'line');
        }

        function returnTextFileLines(file)
        {
            var indicators = [];
            var rawFile = new XMLHttpRequest();
            rawFile.open("GET", file, false);
            rawFile.onreadystatechange = function ()
            {
                if(rawFile.readyState === 4)
                {
                    if(rawFile.status === 200 || rawFile.status == 0)
                    {
                        var allText = rawFile.responseText;
                        var lines = allText.split('\n');
                        for(var i = 0;i < lines.length;i++){
                            indicators.push(lines[i]);
                        }
                    }
                }
            }
            rawFile.send(null);
            return indicators;
        }




        function getIndicatorsByFieldOfInterest(field) {
            var indicators = returnTextFileLines(fieldToIndicatorsTxtMap[field]);
            return indicators;
        }

        function onNewBarUpdateWithYears(start, end, countries) {
            var json2parse = [];

            indicators = getIndicatorsByFieldOfInterest('financial');

            $(".graph").remove();

            var chartIndex = 0;
            //  Some sweet lambda's..
            indicators.forEach( indicator => {
                console.log('indicator: ' + indicator);
                buildJsonFromDataWithoutOptions(json2parse, start, end, countries, indicator);

//                console.log('Done with json..');
                //  End of temporary
                var chartId = 'chart' + chartIndex;
                updateNew(json2parse, 'line', chartId);
                chartIndex++;
            });


        }


        function updateNew(jsonToWorkWith, typeOfChart, chartId) {

            $("#graphs_container").append('<div class="col-sm-6 graph"> <h5>Hi whats up..!</h5> <div id=' + chartId + '></div> </div>');

            var xsData = {};
            //  Create an actual chart id with the # jquery id mark
            var actualChartId = '#' + chartId;
            var data2Gen = {bindto: actualChartId, data:{ xs: {}, columns: [], type: typeOfChart},subchart: {show: true}, zoom: {enabled: true}};

            for (i = 0; i < jsonToWorkWith.length; i++) {
                var countryName = '';


                var isrYears = ['Year'];
                var isrVals = [];

                var json2parse = jsonToWorkWith[i];

//                console.log(json2parse[0]);

                json2parse.forEach(function (d) {
                    countryName = d.countryLabel;
                    isrVals.push(countryName);
                    d.x.forEach(function (j) {
                        if (typeof j === 'string') {
                            isrYears.push(parseInt(j));
                        }
                        else {
                            isrYears.push(j);
                        }
                    });
                    d.y.forEach(function (j) {
                        if (j == null) {
                            isrVals.push(0);
                        }
                        else {
                            isrVals.push(j);
                        }
                    });
                    //                isrYears.push(d.Year);
                    //                isrVals.push(d.Val);
                })

//                console.log(isrYears);
//                console.log(isrVals);
//                console.log(typeof countryName);

                xsData[countryName] = 'Year';


                data2Gen.data.columns.push(isrVals,isrYears);
                data2Gen.data.xs[countryName] = 'Year';


            }


//            console.log(data2Gen);
            var chart = c3.generate(data2Gen);

//        var chart = c3.generate({
//            data: {
//                xs: xsData,
//                columns: [isrVals, isrYears
//
//                ],
//                type: typeOfChart,
//            }
//        });
        }

        setUpListeners();
        setSixDaysWar1967();





    </script>
</body>
</html>